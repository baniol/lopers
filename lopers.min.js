//     Lopers.js 0.0.3
//     (c) 2012 Marcin Baniowski, baniowski.pl
//     Lopers may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://...
var Lopers=function(e){var t=this;this.version="0.0.3",this.built="20130104",this.debug=!0;if(e===undefined||e==="")throw new Error("db name not defined or empty string");this._dbName=e,this._schemas=[],this._db,localStorage.getItem("lopers_cid_count")===null?(this._lastCid=0,localStorage.setItem("lopers_cid_count",this._lastCid)):this._lastCid=localStorage.getItem("lopers_cid_count");var n=localStorage.getItem(t._dbName);if(n===null)this._db=localStorage.setItem(t._dbName,JSON.stringify([])),this._db=[];else try{this._db=JSON.parse(n)}catch(r){throw new Error("String from localStorage is not in valid JSON format")}this.setTable=function(e,t){var n=this;if(typeof e!="string")throw new Error("Table name must be a string!");if(t instanceof Array==0)throw new Error("Fields argument must be an array!");if(t.length==0)throw new Error("Fields argument must not be an empty array!");t.push("cid");var r={table:e,fields:t};this._schemas.push(r),this._checkTableName(e,function(){n._db.push({table:e,records:[]}),n.persistTable()})},this._checkTableName=function(e,t){for(var n in this._db)if(this._db[n].table==e)return!1;typeof t=="function"&&t()},this._getTableData=function(e){var t;for(var n in this._db)this._db[n].table==e&&(t=this._db[n].records);if(t===undefined)throw new Error("Table "+e+" not found!");return t},this._getTableSchema=function(e){var t;for(var n in this._schemas)this._schemas[n].table==e&&(t=this._schemas[n].fields);if(t===undefined)throw new Error("Table "+e+" not found!");return t},this.insert=function(e,t,n){if(e===undefined)throw new Error("Undefined table name");if(t instanceof Array==0)throw new Error("Inserted values object argument must be of Array type");var r={},i=this._getTableSchema(e);if(t.length!==i.length-1)throw new Error("The number of values you trying to insert does not correspod the schema from setTable!");for(var s in i)r[i[s]]=t[s];r.cid=this._getFirstCid();for(var s in this._db)this._db[s].table==e&&this._db[s].records.push(r);this.persistTable(n)},this._getFirstCid=function(){var e=parseInt(this._lastCid);return e++,this._lastCid=e,localStorage.removeItem("lopers_cid_count"),localStorage.setItem("lopers_cid_count",e),e},this.update=function(e,t,n){var r=this._pickRecords(e,t),i=this._pickRecordByIndex(e,r);for(var s in i)for(j in n)s==j&&(i[s]=n[j]);this.persistTable()},this._pickRecordByIndex=function(e,t){var n=this._getTableData(e);return n[t]},this.delete=function(e,t){var n=this._pickRecords(e,t),r=this._getTableData(e);for(var i in n)r.splice(n[i],1);return this.persistTable(),!0},this._pickRecords=function(e,t){var n=this._getTableData(e),r=[];for(var i=0;i<n.length;i++){var s=n[i];for(var o in t){var u=o,a=t[o];if(s[u]==a){var f=this._getIndexByCid(e,s.cid);r.push(f)}}}return r},this.persistTable=function(e){localStorage.removeItem(t._dbName),localStorage.setItem(t._dbName,JSON.stringify(t._db)),typeof e=="function"&&e()},this._getIndexByCid=function(e,t){var n=null,r=this._getTableData(e);for(var i in r)r[i]["cid"]==t&&(n=i);if(n!==null)return n;throw new Error("object doesn`t exist")},this.getOne=function(e,t,n){var r=this._getTableData(e),i=!1;for(var s in r)t!==undefined&&n!==undefined&&r[s][t]==n&&(i=r[s]);return i},this.getRecords=function(e,t,n){e===undefined;var r=this._getTableData(e),i=[];for(var s in r)t!==undefined&&n!==undefined?r[s][t]==n&&i.push(r[s]):i.push(r[s]);return i},this.destroyDB=function(){localStorage.removeItem(this._dbName),localStorage.removeItem("lopers_cid_count"),delete this},this.resetTable=function(){this.db=[],this.persistTable()},this.deleteTable=function(){delete this.db,this.persistTable()},this.countTable=function(e){var t=this._getTableData(e),n=0;for(var r in t)n++;return n}};