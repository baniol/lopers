//     Lopers.js 0.0.4
//     (c) 2012 Marcin Baniowski, baniowski.pl
//     Lopers may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://...
var Lopers=function(e,t){var n=this;this.options={timestamp:!0},t!==undefined&&typeof t=="object"&&t.timestamp!==undefined&&(this.options.timestamp=t.timestamp),this.version="0.0.4",this.built="20130110";if(e===undefined||e==="")throw new Error("db name not defined or empty string");this._dbName=e,this._reserved=["cid","time"],this._schemas=[],this._db,localStorage.getItem(this._dbName+"_lopers_cid_count")===null?(this._lastCid=0,localStorage.setItem(this._dbName+"_lopers_cid_count",this._lastCid)):this._lastCid=localStorage.getItem(this._dbName+"_lopers_cid_count");var r=localStorage.getItem(n._dbName);if(r===null)this._db=localStorage.setItem(n._dbName,JSON.stringify([])),this._db=[];else try{this._db=JSON.parse(r)}catch(i){throw new Error("String from localStorage is not in valid JSON format")}this.setTable=function(e,t){var n=this;if(typeof e!="string")throw new Error("Table name must be a string!");if(t instanceof Array==0)throw new Error("Fields argument must be an array!");if(t.length==0)throw new Error("Fields argument must not be an empty array!");for(var r=0;r<t.length;r++)if(this._reserved.indexOf(t[r])!=-1)throw new Error("Field name "+t[r]+" is reserved!");t.push("cid"),this.options.timestamp===!0&&t.push("time");var i={table:e,fields:t};this._schemas.push(i),this._checkTableName(e,function(){n._db.push({table:e,records:[]}),n._persistTable()})},this.select=function(e,t){return this._pickRecords(e,t,!0)},this.insert=function(e,t,n){if(e===undefined)throw new Error("Undefined table name");if(t instanceof Array==0)throw new Error("Inserted values object argument must be of Array type");var r={},i=this._getTableSchema(e),s=this.options.timestamp?2:1;if(t.length!==i.length-s)throw new Error("The number of values you trying to insert does not correspod the schema from setTable!");for(var o in i)r[i[o]]=t[o];r.cid=this._getFirstCid();if(this.options.timestamp){var u=new Date;r.time=u.getTime()}for(var o in this._db)this._db[o].table==e&&this._db[o].records.push(r);this._persistTable(n)},this.update=function(e,t,n){var r=this._pickRecords(e,t),i=this._pickRecordByIndex(e,r);for(var s in i)for(j in n)s==j&&(i[s]=n[j]);this._persistTable()},this.delete=function(e,t){var n=this._pickRecords(e,t),r=this._getTableData(e);n.length>0?(r.splice(n[0],1),this.delete(e,t)):this._persistTable()},this.getCount=function(e,t){var n=this._pickRecords(e,t,!0);return n.length},this.destroyDB=function(){localStorage.removeItem(this._dbName),localStorage.removeItem(this._dbName+"_lopers_cid_count"),delete this},this.serialize=function(e){var t=localStorage.getItem(this._dbName),n={dbName:this._dbName,counter:this._lastCid},r=JSON.parse(t);return r.push(n),e===undefined?JSON.stringify(r):r},this._checkTableName=function(e,t){for(var n in this._db)if(this._db[n].table==e)return!1;typeof t=="function"&&t()},this._getTableSchema=function(e){var t;for(var n in this._schemas)this._schemas[n].table==e&&(t=this._schemas[n].fields);if(t===undefined)throw new Error("Table "+e+" not found!");return t},this._getTableData=function(e){var t;for(var n in this._db)this._db[n].table==e&&(t=this._db[n].records);if(t===undefined)throw new Error("Table "+e+" not found!");return t},this._getFirstCid=function(){var e=parseInt(this._lastCid);return e++,this._lastCid=e,localStorage.removeItem(this._dbName+"_lopers_cid_count"),localStorage.setItem(this._dbName+"_lopers_cid_count",e),e},this._pickRecordByIndex=function(e,t){var n=this._getTableData(e);return n[t]},this._pickRecords=function(e,t,n){var r=this._getTableData(e);if(t===undefined)return r;var i=[];for(var s=0;s<r.length;s++){var o=r[s];for(var u in t){var a=t[u];for(var f in a){var l=f,c=a[f];if(o[l]==c){var h=this._getIndexByCid(e,o.cid);n===undefined?i.push(h):i.push(o)}}}}return i},this._persistTable=function(e){localStorage.removeItem(n._dbName),localStorage.setItem(n._dbName,JSON.stringify(n._db)),typeof e=="function"&&e()},this._getIndexByCid=function(e,t){var n=null,r=this._getTableData(e);for(var i in r)r[i]["cid"]==t&&(n=i);if(n!==null)return n;throw new Error("object doesn`t exist")},this.resetCounter=function(){localStorage.removeItem(this._dbName+"_lopers_cid_count"),this._lastCid=0},this.resetTable=function(){this.db=[],this._persistTable()},this.deleteTable=function(){delete this.db,this._persistTable()}};